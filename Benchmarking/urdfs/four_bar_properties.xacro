<?xml version="1.0"?>

<robot xmlns:xacro="http://ros.org/wiki/xacro">

    <xacro:property name="effort_limit" value="30"/>
    <xacro:property name="velocity_limit" value="1.0"/>
    <xacro:property name="joint_lower_limit" value="-10"/>
    <xacro:property name="joint_upper_limit" value="10"/>

    <xacro:macro name="L1" params="name">
        <link name="${name}">
            <inertial>
                <mass value="3.3"/>
                <origin xyz="0.0 0.0 0.0"/>
                <inertia ixx="0.011253" ixy="0" ixz="0" iyy="0.036203" iyz="0" izz="0.042673"/>
            </inertial>
            <visual>
                <origin xyz="0.25 0 0" rpy="0 0 0"/>
                <geometry>
                    <box size="0.5 0.05 0.05"/>
                </geometry>
                <material name="Blue">
                    <color rgba="0.1 0 0.8 1.0"/>
                </material>
        </visual>
        </link>
    </xacro:macro>

    <xacro:macro name="L2" params="name">
        <link name="${name}">
            <inertial>
                <mass value="3.3"/>
                <origin xyz="0.0 0.0 0.0"/>
                <inertia ixx="0.011253" ixy="0" ixz="0" iyy="0.036203" iyz="0" izz="0.042673"/>
            </inertial>
            <visual>
                <origin xyz="0.25 0 0" rpy="0 0 0"/>
                <geometry>
                    <box size="0.5 0.05 0.05"/>
                </geometry>
                <material name="Red">
                    <color rgba="0.8 0.1 0.1 1.0"/>
                </material>
        </visual>
        </link>
    </xacro:macro>

    <xacro:macro name="L3" params="name">
        <link name="${name}">
            <inertial>
                <mass value="3.3"/>
                <origin xyz="0.0 0.0 0.0"/>
                <inertia ixx="0.011253" ixy="0" ixz="0" iyy="0.036203" iyz="0" izz="0.042673"/>
            </inertial>
            <visual>
                <origin xyz="0.5 0 0" rpy="0 0 0"/>
                <geometry>
                    <box size="1.0 0.05 0.05"/>
                </geometry>
                <material name="Green2">
                    <color rgba="0.1 0.8 0 1.0"/>
                </material>
            </visual>
        </link>
    </xacro:macro>

    <xacro:macro name="J1" params="name parent_link child_link">
        <joint name="${name}" type="revolute" independent="false">
            <parent link="${parent_link}"/>
            <child link="${child_link}"/>
            <origin xyz="1.0 0.0 0.0"/>
            <axis xyz="0 0 1"/>
            <limit effort="${effort_limit}" velocity="${velocity_limit}"
                   lower="${joint_lower_limit}" upper="${joint_upper_limit}"/>
        </joint>
    </xacro:macro>

    <xacro:macro name="J2" params="name parent_link child_link">
        <joint name="${name}" type="revolute" independent="true">
            <parent link="${parent_link}"/>
            <child link="${child_link}"/>
            <origin xyz="0.0 0.0 0.0"/>
            <axis xyz="0 0 1"/>
            <limit effort="${effort_limit}" velocity="${velocity_limit}"
                   lower="${joint_lower_limit}" upper="${joint_upper_limit}"/>
        </joint> 
    </xacro:macro>
    
    <xacro:macro name="J3" params="name parent_link child_link">
        <joint name="${name}" type="revolute" independent="false">
            <parent link="${parent_link}"/>
            <child link="${child_link}"/>
            <origin xyz="0.5 0.0 0.0"/>
            <axis xyz="0 0 1"/>
            <limit effort="${effort_limit}" velocity="${velocity_limit}"
                   lower="${joint_lower_limit}" upper="${joint_upper_limit}"/>
        </joint>
    </xacro:macro>

    <xacro:macro name="constraint" params="name predecessor successor">
        <loop name="${name}" type="revolute">
            <predecessor link="${predecessor}">
                <origin xyz="0.5 0.0 0.0"/>
            </predecessor>
            <successor link="${successor}">
                <origin xyz="1.0 0.0 0.0"/>
            </successor>
            <axis xyz="0 0 1"/>
        </loop>
    </xacro:macro>

    <xacro:macro name="root_branch" params="branch_count">
        <xacro:if value="${branch_count}">
            <xacro:L1 name="link_${(branch_count - 1) * 3 + 1}"/>
            <xacro:L2 name="link_${(branch_count - 1) * 3 + 2}"/>
            <xacro:L3 name="link_${(branch_count - 1) * 3 + 3}"/>
            <xacro:J1 name="base_to_link_${(branch_count - 1) * 3 + 1}"
                      parent_link="base"
                      child_link="link_${(branch_count - 1) * 3 + 1}"/>
            <xacro:J2 name="base_to_link_${(branch_count - 1) * 3 + 2}"
                      parent_link="base"
                      child_link="link_${(branch_count - 1 ) * 3 + 2}"/>
            <xacro:J3 name="link_${(branch_count - 1) * 3 + 2}_to_link_${(branch_count - 1) * 3 + 3}"
                      parent_link="link_${(branch_count - 1) * 3 + 2}"
                      child_link="link_${(branch_count - 1) * 3 + 3}"/>
            <xacro:constraint name="constraint_${(branch_count - 1) * 3 + 1}"
                            predecessor="link_${(branch_count - 1) * 3 + 1}"
                            successor="link_${(branch_count - 1) * 3 + 3}"/>

            <xacro:root_branch branch_count="${branch_count - 1}"/>
        </xacro:if>
    </xacro:macro>

    <xacro:macro name="one_four_bar_chain" params="parent_link_idx child_link_idx">
        <xacro:L1 name="link_${child_link_idx}"/>
        <xacro:L2 name="link_${child_link_idx + 1}"/>
        <xacro:L3 name="link_${child_link_idx + 2}"/>
        <xacro:J1 name="link_${parent_link_idx}_to_link_${child_link_idx}"
                  parent_link="link_${parent_link_idx}"
                  child_link="link_${child_link_idx}"/>
        <xacro:J2 name="link_${parent_link_idx}_to_link_${child_link_idx + 1}"
                  parent_link="link_${parent_link_idx}"
                  child_link="link_${child_link_idx + 1}"/>
        <xacro:J3 name="link_${child_link_idx + 1}_to_link_${child_link_idx + 2}"
                  parent_link="link_${child_link_idx + 1}"
                  child_link="link_${child_link_idx + 2}"/>
        <xacro:constraint name="constraint_${child_link_idx}"
                          predecessor="link_${child_link_idx}"
                          successor="link_${child_link_idx + 2}"/>
    </xacro:macro>

    <xacro:macro name="sequential_four_bar_chain" params="parent_link_idx count">
        <xacro:if value="${count - 1}">
            <xacro:one_four_bar_chain parent_link_idx="${parent_link_idx}"
                                      child_link_idx="${parent_link_idx + 3}"/>

            <xacro:sequential_four_bar_chain parent_link_idx="${parent_link_idx + 3}"
                                             count="${count - 1}"/>
        </xacro:if>
    </xacro:macro>

    <xacro:macro name="nonsequential_serial_chain" params="parent_link_idx first_child_link_idx count">
        <xacro:one_four_bar_chain parent_link_idx="${parent_link_idx}"
                                  child_link_idx="${first_child_link_idx}"/>
        <xacro:sequential_four_bar_chain parent_link_idx="${first_child_link_idx}"
                                         count="${count - 1}"/>
    </xacro:macro>

</robot>
