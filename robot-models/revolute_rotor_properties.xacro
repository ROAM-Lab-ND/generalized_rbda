<?xml version="1.0"?>

<robot xmlns:xacro="http://ros.org/wiki/xacro">
    
    <xacro:property name="effort_limit" value="30"/>
    <xacro:property name="velocity_limit" value="1.0"/>
    <xacro:property name="joint_lower_limit" value="-10"/>
    <xacro:property name="joint_upper_limit" value="10"/>
    <xacro:property name="link_mass" value="1"/>
    <xacro:property name="rotor_mass" value="0"/>

    <!-- NOTE(@nicholasadr): Had to separate independent and dependent joint macro
                             because urdf will capitalize the first letter of boolean 
                             parameter "true/false" to "True/False", leading to
                             incorrect joint registration -->
    <xacro:macro name="independent_joint" params="name parent child">
        <joint name="${name}" type="revolute" independent="true">
            <parent link="${parent}"/>
            <child link="${child}"/>
            <axis xyz="0 0 1"/>
            <origin xyz="1.0 0.0 0.0"/>
            <limit effort="${effort_limit}" velocity="${velocity_limit}"
                   lower="${joint_lower_limit}" upper="${joint_upper_limit}"/>
        </joint>
    </xacro:macro>

    <xacro:macro name="dependent_joint" params="name parent child">
        <joint name="${name}" type="revolute" independent="false">
            <parent link="${parent}"/>
            <child link="${child}"/>
            <axis xyz="0 0 1"/>
            <origin xyz="1.0 0.0 0.0"/>
            <limit effort="${effort_limit}" velocity="${velocity_limit}"
                   lower="${joint_lower_limit}" upper="${joint_upper_limit}"/>
        </joint>
    </xacro:macro>

    <xacro:macro name="link" params="name">
        <link name="${name}">
            <inertial>
                <mass value="${link_mass}"/>
                <origin rpy="0 0 0" xyz="0.5 0 0"/>
                <inertia ixx="1" ixy="0" ixz="0" iyy="1" iyz="0" izz="1"/>
            </inertial>
        </link>
    </xacro:macro>
        
    <xacro:macro name="rotor" params="name">
        <link name="${name}">
            <inertial>
                <mass value="${rotor_mass}"/>
                <origin rpy="0 0 0" xyz="0 0 0"/>
                <inertia ixx="1e-4" ixy="0" ixz="0" iyy="1e-4" iyz="0" izz="1e-4"/>
            </inertial>
        </link>
    </xacro:macro>

    <xacro:macro name="transmission" params="name predecessor successor">
        <constraint name="${name}" type="rolling">
            <predecessor link="${predecessor}"/>
            <successor link="${successor}"/>
            <ratio value="6.0"/>
        </constraint>
    </xacro:macro>

    <xacro:macro name="root_branch" params="branch_count">
        <xacro:if value="${branch_count}">
            <xacro:independent_joint name="base_to_link_${branch_count}"
                                     parent="base" child="link_${branch_count}"/>
            <xacro:link name="link_${branch_count}"/>
            <xacro:dependent_joint name="base_to_rotor_${branch_count}"
                                   parent="base" child="rotor_${branch_count}"/>
            <xacro:rotor name="rotor_${branch_count}"/>
            <xacro:transmission name="transmission_${branch_count}"
                                predecessor="link_${branch_count}" successor="rotor_${branch_count}"/>

            <xacro:root_branch branch_count="${branch_count - 1}"/>
        </xacro:if>
    </xacro:macro>

    <xacro:macro name="serial_chain" params="start_link_idx count">
        <xacro:if value="${count}">
            <xacro:independent_joint name="link_${start_link_idx}_to_link_${start_link_idx + 1}"
                                     parent="link_${start_link_idx}" child="link_${start_link_idx + 1}"/>
            <xacro:link name="link_${start_link_idx + 1}"/>
            <xacro:dependent_joint name="link_${start_link_idx}_to_rotor_${start_link_idx + 1}"
                                     parent="link_${start_link_idx}" child="rotor_${start_link_idx + 1}"/>
            <xacro:rotor name="rotor_${start_link_idx+1}"/>
            <xacro:transmission name="transmission_${start_link_idx + 1}"
                                predecessor="link_${start_link_idx + 1}"
                                successor="rotor_${start_link_idx + 1}"/>

            <xacro:serial_chain start_link_idx="${start_link_idx + 1}" count="${count - 1}"/>
        </xacro:if>
    </xacro:macro>

</robot>